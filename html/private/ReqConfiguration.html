<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html>
<head>
<meta name="author of conversion perl script" content="Hartmut Pohlheim" />
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />

<meta name="description" content=" REQCONFIGURATION Envía el mensaje RequestConfiguration al objeto XBusMaster " />
<meta name="keywords" content="  creaxbusmaster setmtoutputmode setperiod " />
<title>Documentation of  ReqConfiguration</title>
</head>
<body >
<h1 >Documentation of  ReqConfiguration</h1>
<hr size="3" noshade="noshade" />

<p align="center">Global Index (<a href = "../indexsgf.html">short</a> | <a href = "../indexlgf.html">long</a>)
 | <a href="Contentsprivate.html">Local contents</a>
 | Local Index (<a href = "indexslfprivate.html">short</a> | <a href = "indexllfprivate.html">long</a>)
</p>

<hr size="3" noshade="noshade" />
<h2 >Function Synopsis</h2>
<pre>[XBusMaster]=ReqConfiguration(XBusMaster)</pre>
<hr size="3" noshade="noshade" />
<h2 >Help text</h2>
<pre>
 REQCONFIGURATION Envía el mensaje RequestConfiguration al objeto XBusMaster

 REQCONFIGURATION Envía el mensaje RequestConfiguration al objeto XBusMaster. El proceso
         se queda bloqueado hasta recibir la información
 
 Syntax: [XBusMaster]=ReqConfiguration(XBusMaster)
 
 Input parameters:
   XBusMaster-&gt; Objeto con la información del dispositivo.

 Output parameters:
   XBusMaster- Es el mismo objeto de entrada que puede haber sido
               modificado durante la llamada.

 Examples:
 &gt;&gt; [xb]=ReqConfiguration(xb);

 See also: <a class="mfun" href="../private/creaxbusmaster.html">creaxbusmaster</a>, <a class="mfun" href="../private/gotoconfig.html">gotoconfig</a>, <a class="mfun" href="../private/pararcaptura.html">pararcaptura</a>, <a class="mfun" href="../private/continuarcaptura.html">continuarcaptura</a>,
           <a class="mfun" href="../private/destruyexbusmaster.html">destruyexbusmaster</a>
</pre>
<hr size="3" noshade="noshade" />
<h2 >Cross-Reference Information</H2>
<table border="0" width="100%">
<tr align="left">
<th width="50%"></th>
<th width="50%">This function is called by</th>
</tr>
<tr valign="top"><td></td><td>
<ul>
<li><a class="mfun" href="../private/creaxbusmaster.html">creaxbusmaster</a></li>
<li><a class="mfun" href="../private/SetMTOutputMode.html">SetMTOutputMode</a></li>
<li><a class="mfun" href="../private/SetPeriod.html">SetPeriod</a></li>
</ul>
</td>
</tr>
</table>
<hr size="3" noshade="noshade" />
<h2 >Listing of function ReqConfiguration</h2>
<pre>


<em class="mcom">% Author:   Rafael C. Gonzalez de los Reyes</em>
<em class="mcom">% History:  04.12.07    creacion del archivo</em>
<em class="mcom">%           18.12.07    pasada a private por Diego.</em>


function [XBusMaster]=ReqConfiguration(XBusMaster)

<em class="mcom">% Envia el mensaje <a class="mfun" href="../private/initbus.html">InitBus</a> al objeto XBusMaster</em>
<em class="mcom">% error vale 1 si no se recibe el mensaje con la descripcion</em>
<em class="mcom">% de los dispositivos conectados</em>
<em class="mcom">% El proceso se queda bloqueado hasta recibir la informacion</em>

<em class="mcom">% Cuerpo del mensaje (excepto el byte de checksum)</em>
msg=[250,255,12,0];
<em class="mcom">% Se calcula el cheksum y se coloca al final</em>
msg=[msg 256-mod(sum(msg(2:end)),256)];
<em class="mcom">% Se envia por el puerto serie </em>
if (XBusMaster.puerto.BytesAvailable&gt;0)
    <em class="mcom">% Vaciar el puerto </em>
    <em class="mcom">% OJO!!! Los datos se perderan</em>
    disp(['&gt;&gt;&gt; AVISO: Se descartaran ' int2str(XBusMaster.puerto.BytesAvailable) ' datos']);
    fread(XBusMaster.puerto,XBusMaster.puerto.BytesAvailable,'uint8');
end
<em class="mcom">% El valor del TimeOut se fija a 1 segundo</em>
<em class="mcom">%tout=XBusMaster.puerto.TimeOut;</em>
XBusMaster.puerto.Timeout=1;
fwrite(XBusMaster.puerto,msg,'uint8','async');
<em class="mcom">% Se espera a recibir la contestacion</em>
<em class="mcom">% Se supone que el buffer de entrada esta vacio</em>
<em class="mcom">%msg=[];</em>
<em class="mcom">% Primero se leen 4 bytes para concer la longitud total del mensaje</em>
<em class="mcom">% NOTA: Al no conocer la longitud total de mensaje, si especificamos el</em>
<em class="mcom">% maximo valor posible, la funcion fread se bloquearia hasta que venciese</em>
<em class="mcom">% el tout.</em>
[ack1,cnt1,msg]=fread(XBusMaster.puerto,4,'uint8');
if (cnt1&lt;4 || ~isempty(msg))
    disp(msg);
    error('no se ha recibido la respuesta en ReqConfiguration');
else
    if (ack1(3)~=13)
        error('Error en la secuencia de mensajes duranta ReqConfiguration');
    end
end
<em class="mcom">% de momento no se ha detectado ningun error y se continua con la lectura</em>
<em class="mcom">% del resto del mensaje ack1(end)+1 bytes</em>
[ack2,cnt2,msg]=fread(XBusMaster.puerto,ack1(end)+1,'uint8');
ack=[ack1; ack2];
if (~isempty(msg))
    disp(msg);
    error('no se ha recibido la respuesta en ReqConfiguration');
else
    if (mod(sum(ack(2:end)),256)~=0)
        error('Error de checksum durante ReqConfiguration');
    end
    <em class="mcom">% XBusMaster.Configuracion=ack(5:(end-1));</em>
    XBusMaster.Conf.MDID=ack(5:8);
    XBusMaster.Conf.SampPeriod=115200/([256 1]*ack(9:10));
    XBusMarter.Conf.OutputSkipFactor=[256 1]*ack(11:12);
    XBusMaster.Conf.SyncMode=[256 1]*ack(13:14);
    XBusMaster.Conf.SyncSkipFactor=[256 1]*ack(15:16);
    XBusMaster.Conf.SyncOffset=(256.^[3 2 1 0])*ack(17:20);
    XBusMaster.Conf.Date.Year=(10.^[3 2 1 0])*ack(21:24);
    XBusMaster.Conf.Date.Month=(10.^[1 0])*ack(25:26);
    XBusMaster.Conf.Date.Day=(10.^[1 0])*ack(27:28);
    XBusMaster.Conf.Time.Hour=[10 1]*ack(29:30);
    XBusMaster.Conf.Time.Min=[10 1]*ack(31:32);
    XBusMaster.Conf.Time.Sec=[10 1]*ack(33:34);
    XBusMaster.Conf.Time.CS=[10 1]*ack(35:36);
    XBusMaster.Conf.DevNum=[256 1]*ack(101:102);
    for k=1:(XBusMaster.Conf.DevNum)
        base=103+20*(k-1)-1;
        XBusMaster.Conf.Dev(k).ID=ack(base+(1:4));
        XBusMaster.Conf.Dev(k).DataLength=[256 1]*ack(base+(5:6));
        XBusMaster.Conf.Dev(k).OutputMode=[256 1]*ack(base+(7:8));
        XBusMaster.Conf.Dev(k).OutputSettings=[256 1]*ack(base+(9:10));
    end
end
</pre>
<hr size="3" noshade="noshade" />
<!--navigate-->
<!--copyright-->
</body>
</html>
